<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password â€” Safarigari Driver</title>
  <style>
    :root{
      --bg:#f3fff6;
      --card:#ffffff;
      --accent:#1f9d6a; /* greenish */
      --accent-2:#17b169;
      --muted:#6b7280;
      --danger:#dc2626;
      --radius:12px;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,var(--bg),#ecfff1);display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:520px;background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(31,45,46,0.08);padding:28px}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    h1{margin:0 0 6px 0;font-size:20px}
    p.lead{margin:0 0 18px 0;color:var(--muted)}
    form{display:flex;flex-direction:column;gap:12px}
    label{font-size:13px;color:#374151}
    input[type=password]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6eef0;font-size:15px}
    .hint{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:12px}
    .btn{appearance:none;border:0;padding:12px 16px;border-radius:10px;background:var(--accent);color:white;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:0.6;cursor:not-allowed}
    .secondary{background:transparent;border:1px solid #e6eef0;color:#111}
    .msg{padding:10px;border-radius:8px;font-size:14px}
    .msg.success{background:#ecfdf5;color:#065f46}
    .msg.error{background:#fff1f2;color:#7f1d1d}
    footer{margin-top:16px;font-size:13px;color:var(--muted);text-align:center}
    @media(min-width:720px){.card{padding:36px}}
  </style>
</head>
<body>
  <main class="card" role="main">
    <div class="brand">
      <div class="logo">SG</div>
      <div>
        <h1>Reset your password</h1>
        <p class="lead">Enter a new password for your Safarigari driver account. This link expires in 30 minutes.</p>
      </div>
    </div>

    <div id="alert" style="display:none" class="msg"></div>

    <form id="resetForm" novalidate>
      <input type="hidden" id="driverId" name="driver_id" />
      <input type="hidden" id="token" name="token" />

      <div>
        <label for="password">New password</label>
        <input id="password" name="new_password" type="password" placeholder="Create a strong password" autocomplete="new-password" required minlength="8" />
        <div class="hint">Minimum 8 characters. Use a mix of letters and numbers.</div>
      </div>

      <div>
        <label for="confirm">Confirm new password</label>
        <input id="confirm" name="confirm_password" type="password" placeholder="Confirm your password" autocomplete="new-password" required minlength="8" />
      </div>

      <div style="display:flex;gap:12px;margin-top:4px">
        <button id="submitBtn" class="btn" type="submit">Reset password</button>
        <button id="cancelBtn" type="button" class="btn secondary" onclick="location.href='/'">Cancel</button>
      </div>

    </form>

    <footer>Need help? Contact support at <a href="mailto:support@safarigari.com">support@safarigari.com</a></footer>
  </main>

  <script>
    // Helpers
    const qs = (sel, root = document) => root.querySelector(sel);
    const showMsg = (type, text) => {
      const el = qs('#alert');
      el.className = 'msg ' + (type === 'success' ? 'success' : 'error');
      el.textContent = text;
      el.style.display = 'block';
    }

    // Extract params from URL (u = driver id, token)
    function getParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        u: params.get('u') || params.get('driver_id') || '',
        token: params.get('token') || ''
      };
    }

    // Populate hidden inputs
    (function init() {
      const p = getParams();
      if (!p.u || !p.token) {
        showMsg('error', 'Invalid or missing reset link. Please request a new password reset.');
        qs('#resetForm').style.display = 'none';
        return;
      }
      qs('#driverId').value = p.u;
      qs('#token').value = p.token;

      // optional: focus first input
      qs('#password').focus();
    })();

    // Form submission
    qs('#resetForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();

      const submitBtn = qs('#submitBtn');
      const driverId = qs('#driverId').value.trim();
      const token = qs('#token').value.trim();
      const pw = qs('#password').value;
      const cpw = qs('#confirm').value;

      // Basic validation
      if (pw.length < 8) return showMsg('error', 'Password must be at least 8 characters long.');
      if (pw !== cpw) return showMsg('error', "Passwords don't match.");

      submitBtn.disabled = true; submitBtn.textContent = 'Resetting...';
      showMsg('',''); // clear

      try {
        const payload = {
          driver_id: Number(driverId),
          token: token,
          new_password: pw
        };

        const res = await fetch('/api/v1/auth/driver/password-reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          const errMsg = (data && data.message) ? data.message : 'Failed to reset password';
          showMsg('error', errMsg + (data.error ? (': ' + data.error) : ''));
          submitBtn.disabled = false; submitBtn.textContent = 'Reset password';
          return;
        }

        showMsg('success', (data && data.message) ? data.message : 'Password reset successfully. You can now sign in.');
        submitBtn.textContent = 'Done';
        // Optionally redirect after short delay
        setTimeout(() => window.location.href = '/auth/driver/login', 2000);

      } catch (err) {
        showMsg('error', 'An unexpected error occurred. Please try again.');
        console.error(err);
        submitBtn.disabled = false; submitBtn.textContent = 'Reset password';
      }

    });
  </script>
</body>
</html>
